<!DOCTYPE html>
<html ng-app="nlapp">
<head>
<meta charset="UTF-8">
<title>AngularJS Debate Test</title>
<script src="js/jquery.min.js"></script>
<script src="js/angular.min.js"></script>
<script src="js/angular-sanitize.min.js"></script>
</head>
<body ng-controller="DebateController">
  <section>
    <div>newsID: {{news.newsID}}</div>
    <div>{{str2date(news.createdDateTime)|date:'dd-MM-yy'}}</div>
    <div ng-show="notification.count>0">new notifications: {{notification.count}}</div>
    <div style="float:right">{{userID}}</div>
    <div style="float:right">{{displayName}}</div>
    <div>Title: {{news.newsTitle}}</div>
    <div><img src="{{news.newsBannerSource}}"></div>
    <div>Question: {{news.newsQuestion}}</div>
    <div>
      <div> {{percenty | number:0}}% agree</div>
      <div style="float:right"> {{percentn | number:0}}% disagree</div>
    </div>
    <div>
      <button name="voteAgree" id="voteAgree" ng-click="submitAgree()">agree {{bUserVoteDisagree()?"disabled":""}}</button>
      <button name="voteDisagree" id="voteDisagree" ng-click="submitDisagree()">disagree {{bUserVoteAgree()?"disabled":""}}</button>
    </div>
    <div ng-show="bUserVoteAgree()">
      <form name="agreeForm" id="agreeForm" ng-submit="submitReply('agree')" novalidate>
      <p>tell us why yes</p>
      <textarea name="agreeArea" id="agreeArea" ng-model="agreeArea" required></textarea>
      <p style="color:red" ng-show="!agreeAreaValid">please input something here</p>
      <button type="submit">submit yes</button>
      </form>
    </div>
    <div ng-show="bUserVoteDisagree()">
      <form name="disagreeForm" id="disagreeForm" ng-submit="submitReply('disagree')" novalidate>
      <p>tell us why no</p>
      <textarea name="disagreeArea" id="disagreeArea" ng-model="disagreeArea" required></textarea>
      <p style="color:red" ng-show="!disagreeAreaValid">please input something here</p>
      <button type="submit">submit no</button>
      </form>
    </div>
    <div ng-repeat="reply in replyList" style="border: 1px solid black">
      <div>{{reply.replyID}}</div>
      <div>{{reply.replyType}}</div>
      <div>{{reply.displayName}}</div>
      <div>{{str2date(reply.replyCreatedDateTime) | date:'dd-MM-yy'}}</div>
      <!--div>{{reply.replyContent}}</div-->
      <div ng-bind-html="reply.replyContent"></div>
      <div>Reply {{reply.subReplies.count}}</div>
      <div><a href="javascript:;" ng-click="submitReply('like', reply.replyID)">{{bUserLikeThisReply(reply)?"LIKE":"like"}}</a> {{reply.likes.count}}</div>
      <div ng-show="reply.userID==userID"><a href="javascript:;" ng-click="removeReply(reply.replyID)">remove</a></div>
      <div><form ng-submit="submitSubreply(reply.replyType, reply.replyID, $index)" novalidate>
      <textarea ng-model="subreplyArea[$index]" required></textarea>
      <p style="color:red" ng-show="subreplyAreaNotValid[$index]">please input something here</p>
      <button type="submit">submit subreply</button>
      </form></div>
      <div ng-repeat="sub in reply.subReplies.list" style="border: 1px solid blue">
        <div>{{sub.replyID}}</div>
        <div>{{sub.displayName}}</div>
        <div>{{str2date(sub.subreplyCreatedDateTime) | date:'dd-MM-yy'}}</div>
        <div>{{sub.replyContent}}</div>
        <div ng-show="sub.userID==userID"><a href="javascript:;" ng-click="removeReply(reply.replyID, sub.replyID)">remove</a></div>
      </div>
    </div>
  </section>
  <script>
	var newsID = 272;
	
	angular.module("nlapp", ['ngSanitize']).config(function($httpProvider) {
	    //Enable cross domain calls
	    $httpProvider.defaults.useXDomain = true;
	    $httpProvider.defaults.withCredentials = true;
	    $httpProvider.defaults.headers.post = {
			    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
		  };
	}).controller("DebateController", function($scope, $http){

		
		$http({method: 'GET', url: '//api.nl.com/auth'}).success(
			function (data, status, headers, config, statusText) {
				if (angular.isDefined(data.userID)) {
					$scope.userID = data.userID;
					$scope.displayName = data.displayName;
					
					if (true) {
						var urlNotification = "//api.nl.com/user/"+$scope.userID+"/notification";
						$http({method: 'get', url: urlNotification}).success(
							function(data, status, headers, config, statusText){
								if (angular.isDefined(data.notification))
									$scope.notification = data.notification;
							});
					}
				}
			}
		);

		$http({method: 'GET', url: '//api.nl.com/news/'+newsID}).success(
			function (data, status, headers, config, statusText) {
				if (typeof data.news != 'undefined') {
					if (data.news.newsBannerSource.indexOf("://") < 0)
						data.news.newsBannerSource = "//"+data.news.newsBannerSource;
					$scope.news = data.news;
				}
			}
		);
		
		$http({method: 'GET', url: '//api.nl.com/news/'+newsID+'/reply'}).success(
			function (data, status, headers, config, statusText) {
				if (typeof data.replyList != 'undefined') {
					$scope.replyList = data.replyList;
				}
			}
		);
		
		var updateVoteResult = function(data) {
			if (typeof data.vote != 'undefined') {
				var vy = data.vote.agree.count;
				var vn = data.vote.disagree.count;

				if (vy+vn > 0) {
					$scope.percenty = vy * 100 / (vy+vn);
					$scope.percentn = vn * 100 / (vy+vn);
				} else {
					$scope.percenty = 0;
					$scope.percentn = 0;
				}
				
				$scope.vote = data.vote;
			}			
		};
		
		$http({method: 'GET', url: '//api.nl.com/news/'+newsID+'/vote'}).success(
			function (data, status, headers, config, statusText) {
				updateVoteResult(data);
			}
		);
		
		$scope.bUserVoteAgree = function() {
			for (i in $scope.vote.agree.votes) {
				if ($scope.userID == $scope.vote.agree.votes[i].userID) {
					return true;
				}
			}
			
			return false;
		};
		
		$scope.bUserVoteDisagree = function() {
			for (i in $scope.vote.disagree.votes) {
				if ($scope.userID == $scope.vote.disagree.votes[i].userID)
					return true;
			}
			return false;
		};
		
		$scope.bUserLikeThisReply = function(reply) {
			if (typeof reply.likes != 'undefined') {
				for (i in reply.likes.list) {
					if ($scope.userID == reply.likes.list[i].userID)
						return true;
				}
			}

			return false;
		};
		
		$scope.str2date = function(str) {
			return new Date(str);
		};
		
		var submitVote = function(vote) {
			var urlVote = "//api.nl.com/news/"+$scope.news.newsID+"/vote";
			var postData = "voteType="+vote;
			$http({	method: 'post', url: urlVote, data: postData}).success(
					function(data, status, headers, config, statusText){
						updateVoteResult(data);
					});
		};
		
		$scope.submitAgree = function() {
			submitVote("agree");
		};
		
		$scope.submitDisagree = function() {
			submitVote("disagree");
		};
		
		var updateReply = function(data) {
			if (angular.isDefined(data.reply) && data.reply.replyID > 0) {
				for (i in $scope.replyList) {
					if ($scope.replyList[i].replyID == data.reply.replyID) {
						$scope.replyList[i] = data.reply;
						return true;
					}
				}

				var replyList = [data.reply];
				$.merge(replyList, $scope.replyList);
				$scope.replyList = replyList;
				
				return true;
			} else if (angular.isDefined(data.errCode) && data.errCode == 0 &&
					angular.isDefined(data.replyID) && data.replyID > 0) {
				for (i in $scope.replyList) {
					if ($scope.replyList[i].replyID == data.replyID) {
						$scope.replyList.splice(i, 1);
						return true;
					}
				}
			}
			return false;
		}
		
		$scope.agreeAreaValid = true;
		$scope.disagreeAreaValid = true;

		$scope.submitReply = function(replyType, replyID) {
			$scope.agreeAreaValid = true;
			$scope.disagreeAreaValid = true;
			
			if (replyType == "agree") {
				$scope.agreeAreaValid = $scope.agreeForm.agreeArea.$valid;
				
				if ($scope.agreeForm.$valid) {
					var urlReply = "//api.nl.com/news/"+$scope.news.newsID+"/reply";
					if (replyID > 0)
						urlReply += "/"+replyID;
					var postData = {
							replyType: replyType,
							replyContent: $scope.agreeArea
						};
					$http({method: 'post', url: urlReply, data: $.param(postData)}).success(
							function(data, status, headers, config, statusText) {
								if (updateReply(data))
									$scope.agreeArea = "";
							});
				}
			} else if (replyType == "disagree") {
				$scope.disagreeAreaValid = $scope.disagreeForm.disagreeArea.$valid;
				
				if ($scope.disagreeForm.$valid) {
					var urlReply = "//api.nl.com/news/"+$scope.news.newsID+"/reply";
					if (replyID > 0)
						urlReply += "/"+replyID;
					var postData = {
							replyType: replyType,
							replyContent: $scope.disagreeArea
						};
					$http({method: 'post', url: urlReply, data: $.param(postData)}).success(
							function(data, status, headers, config, statusText) {
								if (updateReply(data))
									$scope.disagreeArea = "";
							});
				}
			} else if (replyType == "like") {
				if (replyID > 0) {
					var urlReply = "//api.nl.com/news/"+$scope.news.newsID+"/reply/"+replyID;
					var postData = {
							replyType: replyType
						};
					$http({method: 'post', url: urlReply, data: $.param(postData)}).success(
							function(data, status, headers, config, statusText) {
								updateReply(data);
							});
				}
			} 
		};
		
		$scope.subreplyArea = [];
		$scope.subreplyAreaNotValid = [];
		
		$scope.submitSubreply = function(replyType, replyID, index) {
			//$scope.subreplyArea[index] = $scope.subreplyArea[index].trim();
			if (!angular.isDefined($scope.subreplyArea[index]) || $scope.subreplyArea[index] == "") {
				$scope.subreplyAreaNotValid[index] = true;
			} else {
				$scope.subreplyAreaNotValid[index] = false;
				var urlReply = "//api.nl.com/news/"+$scope.news.newsID+"/reply/"+replyID;
				var postData = {
						replyType: $scope.replyList[index].replyType,
						replyContent: $scope.subreplyArea[index]
					};
				$http({method: 'post', url: urlReply, data: $.param(postData)}).success(
						function(data, status, headers, config, statusText) {
							if (updateReply(data)) {
								$scope.subreplyArea = [];
								$scope.subreplyAreaNotValid = [];
							}
						});
			}
		};
		
		$scope.removeReply = function(replyID, subReplyID) {
			var urlReply = "//api.nl.com/news/"+$scope.news.newsID+"/reply/"+replyID;
			if (angular.isDefined(subReplyID) && subReplyID > 0)
				urlReply += "/"+subReplyID;
			
			$http({method: 'delete', url: urlReply}).success(
					function(data, status, headers, config, statusText) {
						//alert(JSON.stringify(data));
						updateReply(data);
					});
		}
	});
  </script>
</body>
</html>